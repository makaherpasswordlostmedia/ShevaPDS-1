name: iOS Build

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    name: Build iOS App
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: |
          sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer 2>/dev/null || \
          sudo xcode-select -s /Applications/Xcode_15.3.app/Contents/Developer 2>/dev/null || \
          sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer 2>/dev/null || true
          xcodebuild -version

      - name: Create build dir
        run: mkdir -p build

      - name: Show available simulators
        run: xcrun simctl list devices available | grep -E "iPhone" | head -10

      - name: Find simulator
        id: sim
        run: |
          # Try iOS 17 first, then 16
          UDID=$(xcrun simctl list devices available | grep -E "iPhone [0-9]" | grep -v "unavailable" | head -1 | grep -oE "[A-F0-9-]{36}")
          if [ -z "$UDID" ]; then
            echo "No simulator found, listing all:"
            xcrun simctl list devices
            exit 1
          fi
          echo "udid=$UDID" >> $GITHUB_OUTPUT
          echo "Found simulator: $UDID"
          xcrun simctl list devices available | grep "$UDID"

      - name: Build for simulator (Debug)
        run: |
          xcodebuild \
            -project ImlacPDS1.xcodeproj \
            -scheme ImlacPDS1 \
            -destination "id=${{ steps.sim.outputs.udid }}" \
            -configuration Debug \
            -derivedDataPath build/DerivedData \
            CODE_SIGNING_ALLOWED=NO \
            SWIFT_TREAT_WARNINGS_AS_ERRORS=NO \
            clean build \
          2>&1 | tee build/sim.log
          # tee exits 0, check xcodebuild result via log
          grep -q "BUILD SUCCEEDED" build/sim.log && echo "✅ Build OK" || { echo "❌ Build FAILED"; grep "error:" build/sim.log | head -30; exit 1; }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ImlacPDS1-iOS
          path: |
            build/sim.log
            build/DerivedData/Build/Products/
          retention-days: 14
